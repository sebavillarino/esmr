% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/esm.R
\name{esm}
\alias{esm}
\title{Equivalent Soil Mass (ESM) for soil stocks and properties}
\usage{
esm(
  data,
  rvar,
  som = TRUE,
  soc_col = NULL,
  min_core_length_cm = 0,
  output = c("esm", "fd"),
  reference_mode = c("ref_trt", "min", "custom", "min_smm_by_depth"),
  custom_ld = NULL,
  custom_smm = NULL,
  extrapolation = c("none", "to_depth"),
  reference_by = NULL,
  core_by = NULL,
  ...
)
}
\arguments{
\item{data}{Data frame with at least: \code{trt}, \code{rep}, \code{upper}, \code{lower}, \code{bd}, and the column named in \code{rvar}.
If \code{som = TRUE}, also requires a \code{som} column.}

\item{rvar}{String. Name of the response variable column (percent).}

\item{som}{Logical. If \code{TRUE}, use provided \code{som} column; if \code{FALSE}, estimate SOM as \code{2 * SOC} using \code{soc_col}. Default \code{TRUE}.}

\item{soc_col}{String or \code{NULL}. Required when \code{som = FALSE}. Name of SOC (\%) column used to estimate SOM.}

\item{min_core_length_cm}{Numeric. Minimum core length (cm). Default \code{0}.}

\item{output}{\code{"esm"} (default) or \code{"fd"}.}

\item{reference_mode}{\code{"ref_trt"}, \code{"min"}, or \code{"custom"}.
Backward compatible alias: \code{"min_smm_by_depth"} â†’ \code{"min"}.}

\item{custom_ld, custom_smm}{Custom reference grid when \code{reference_mode = "custom"}.
\code{custom_ld} must be strictly increasing; both vectors must have equal length.}

\item{extrapolation}{\code{"none"} (default) or \code{"to_depth"}.
\itemize{
\item \code{"none"}: never extrapolate beyond the maximum \emph{sampled mineral mass} of each profile.
\item \code{"to_depth"}: allow extrapolation up to the maximum \emph{sampled depth} (lower) of each profile.
}}

\item{reference_by}{Optional character vector of columns that define groups \strong{over which the reference is computed}.
If \code{NULL}, \code{"min"} reference is global by depth (entire dataset).}

\item{core_by}{Optional character vector of columns that identify \strong{unique cores/profiles} in addition to \code{trt} and \code{rep}
(e.g., \code{"Site"}, \code{"Plot"}, \code{"Block"}). If \code{NULL}, only \code{trt + rep} identify a core.}

\item{...}{Ignored. Accepts legacy \code{group_by} for backward compatibility (mapped to \code{reference_by}).}
}
\value{
A tibble with per-interval and cumulative outputs. Column \code{bd} is always lowercase.
For \code{output="esm"}, the attribute \code{"SMM_reference"} contains the reference grid used.
}
\description{
Computes per-interval and cumulative quantities for a response variable
(e.g., \\%C, \\%N, pH expressed as \%) using the Equivalent Soil Mass (ESM)
approach, or returns Fixed-Depth (FD) quantities.
}
