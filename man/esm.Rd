% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/esm.R
\name{esm}
\alias{esm}
\title{Equivalent Soil Mass (ESM) for soil stocks and properties}
\usage{
esm(
  data,
  rvar,
  som = TRUE,
  soc_col = NULL,
  min_core_length_cm = 0,
  output = c("esm", "fd"),
  reference_mode = c("treatment_mean", "min_smm_by_depth", "custom"),
  custom_ld = NULL,
  custom_smm = NULL,
  extrapolation = c("none", "to_depth"),
  reference_by = NULL
)
}
\arguments{
\item{data}{Data frame with: \code{trt}, \code{rep}, \code{upper}, \code{lower}, \code{bd}, and \code{rvar}.
Optionally \code{som} (if \code{som = TRUE}) or a SOC column named in \code{soc_col} (if \code{som = FALSE}).
\code{ref_trt} is only required when \code{output = "esm"} and
\code{reference_mode = "treatment_mean"}.}

\item{rvar}{String. Name of the response variable column (percent).}

\item{som}{Logical. If \code{TRUE}, use provided \code{som} column; if \code{FALSE}, estimate
SOM as \code{2 * SOC} using the column named in \code{soc_col}. Default: \code{TRUE}.}

\item{soc_col}{String or \code{NULL}. Required when \code{som = FALSE}. Name of SOC (\%) column.}

\item{min_core_length_cm}{Numeric. Minimum core length (cm). Default 0.}

\item{output}{"esm" (default) or "fd".}

\item{reference_mode}{"treatment_mean" (default), "min_smm_by_depth", or "custom".}

\item{custom_ld, custom_smm}{Custom reference grid when \code{reference_mode = "custom"}.}

\item{extrapolation}{"none" (default) or "to_depth".}

\item{reference_by}{Optional character vector of column names to build the
reference grid by group (e.g., "Site", or c("Site","yr")).}
}
\value{
Tibble with per-interval and cumulative outputs (always with \code{bd} in lowercase).
For \code{output="esm"}, the attribute \code{"SMM_reference"} contains the SMM target grid used
(including \code{reference_by} columns if provided).
}
\description{
Computes per-interval and cumulative quantities for a response variable
(e.g., \%C, \%N, pH) using the Equivalent Soil Mass (ESM) approach, or
at Fixed Depth (FD).
}
\details{
Expected units:
\itemize{
\item \code{upper}, \code{lower}: cm
\item \code{bd}: g cm^-3 (lowercase). If your data has \code{BD}, it is mapped to \code{bd}.
\item \code{som}: percent by mass (\%) when \code{som = TRUE}.
\item When \code{som = FALSE}, you must provide \code{soc_col} (percent by mass, \%), and
SOM is estimated as \code{2 * SOC}.
\item \code{rvar}: percent by mass (\%) if elemental concentration; non-additive props
(e.g., pH) are re-interpolated onto the SMM grid (no "pH stock").
}
}
